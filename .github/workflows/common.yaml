name: common-ci
on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      component:
        required: true
        type: string
      app_type:
        required: true
        type: string
      acc_id:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
jobs:
  ci:
    runs-on: self-hosted
    outputs:
      appVersion: ${{ steps.package-version.outputs.version }}
    steps:
      - name: checkout code
        uses: actions/checkout@v5

      - name: check the files
        run: ls -l

      - name: print inputs
        run: echo "project is ${{ inputs.project }}"

      - name: get app version
        id: package-version
        run: echo "version=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"

      - name: print app version
        run: echo ${{ steps.package-version.outputs.version }}

      - name: install dependencies
        run: npm install

      - name: docker build
        run: docker build --platform=linux/amd64  -t ${{ inputs.acc_id }}.dkr.ecr.us-east-1.amazonaws.com/${{inputs.project}}/${{ inputs.component }}:${{ steps.package-version.outputs.version }} .

      - name: docker push ecr
        run: |
          docker push ${{inputs.acc_id }}.dkr.ecr.us-east-1.amazonaws.com/${{inputs.project}}/${{ inputs.component }}:${{ steps.package-version.outputs.version }}

